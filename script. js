// ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И ДАННЫЕ ==========
let currentView = 'categories'; // categories | topics | messages
let currentCategory = null;
let currentTopic = null;

// Базовая структура данных (сохраняется в LocalStorage)
let forumData = {
    categories: [
        {
            id: 'programming',
            title: 'Программирование',
            desc: 'Python, JavaScript, фреймворки, архитектура',
            icon: 'fa-code',
            topics: 15,
            messages: 84
        },
        {
            id: 'ideas',
            title: 'Идеи для проектов',
            desc: 'Обсуждение, выбор и реализация IT-проектов',
            icon: 'fa-lightbulb',
            topics: 42,
            messages: 210
        },
        {
            id: 'gaming',
            title: 'Киберспорт & Гейминг',
            desc: 'Турниры, стримы, разработка игр и железо',
            icon: 'fa-gamepad',
            topics: 28,
            messages: 156
        },
        {
            id: 'devops',
            title: 'DevOps & Администрирование',
            desc: 'VPS, Docker, облака, мониторинг, безопасность',
            icon: 'fa-server',
            topics: 19,
            messages: 92
        }
    ],
    topics: [],
    messages: []
};

// ========== ИНИЦИАЛИЗАЦИЯ ==========
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем данные из LocalStorage или используем начальные
    loadData();
    
    // Инициализируем интерфейс
    renderCategories();
    setupEventListeners();
    
    // Скрываем кнопку "Назад" на главной
    document.getElementById('btnBack').classList.add('hidden');
});

// ========== РАБОТА С ДАННЫМИ ==========
function loadData() {
    const saved = localStorage.getItem('forumData');
    if (saved) {
        forumData = JSON.parse(saved);
    } else {
        // Создаём несколько примеров тем и сообщений
        createSampleData();
        saveData();
    }
}

function saveData() {
    localStorage.setItem('forumData', JSON.stringify(forumData));
}

function createSampleData() {
    // Пример темы
    forumData.topics = [
        {
            id: 'welcome',
            category: 'programming',
            title: 'Добро пожаловать на форум!',
            author: 'Администратор',
            text: 'Это прототип форума на чистом HTML/CSS/JS. Данные сохраняются в вашем браузере.',
            time: new Date().toLocaleString(),
            messages: 3
        },
        {
            id: 'project-ideas',
            category: 'ideas',
            title: 'Топ-5 идей для пет-проектов на Python',
            author: 'Разработчик',
            text: '1. Бот для отслеживания цен. 2. Персональный дашборд. 3. API-агрегатор. 4. Генератор отчётов. 5. Мини-игра.',
            time: new Date().toLocaleString(),
            messages: 12
        }
    ];
    
    // Пример сообщений
    forumData.messages = [
        {
            id: 'm1',
            topicId: 'welcome',
            author: 'Новичок',
            text: 'Круто! А можно тут реально общаться?',
            time: new Date().toLocaleString()
        },
        {
            id: 'm2',
            topicId: 'welcome',
            author: 'Администратор',
            text: 'Пока это прототип. Но если народу понравится — сделаем настоящий форум с бэкендом!',
            time: new Date().toLocaleString()
        }
    ];
}

// ========== РЕНДЕРИНГ ИНТЕРФЕЙСА ==========
function renderCategories() {
    const container = document.getElementById('categoriesList');
    container.innerHTML = '';
    
    forumData.categories.forEach(cat => {
        const card = document.createElement('div');
        card.className = 'category-card';
        card.dataset.category = cat.id;
        
        card.innerHTML = `
            <div class="category-icon">
                <i class="fas ${cat.icon}"></i>
            </div>
            <h3 class="category-title">${cat.title}</h3>
            <p class="category-desc">${cat.desc}</p>
            <div class="category-stats">
                <span><i class="fas fa-comments"></i> ${cat.topics} тем</span>
                <span><i class="fas fa-reply"></i> ${cat.messages} ответов</span>
            </div>
        `;
        
        card.addEventListener('click', () => openCategory(cat.id));
        container.appendChild(card);
    });
}

function renderTopics(categoryId) {
    const topics = forumData.topics.filter(t => t.category === categoryId);
    const container = document.getElementById('topicsList');
    const title = document.getElementById('currentCategoryTitle');
    const cat = forumData.categories.find(c => c.id === categoryId);
    
    title.textContent = `Темы: ${cat.title}`;
    container.innerHTML = '';
    
    if (topics.length === 0) {
        container.innerHTML = '<div class="topic-item"><p>Пока нет тем. Будьте первым!</p></div>';
        return;
    }
    
    topics.forEach(topic => {
        const item = document.createElement('div');
        item.className = 'topic-item';
        item.dataset.topic = topic.id;
        
        item.innerHTML = `
            <h4 class="topic-title">${topic.title}</h4>
            <p style="color: #94a3b8; margin-bottom: 10px;">${topic.text.substring(0, 150)}...</p>
            <div class="topic-meta">
                <span><i class="fas fa-user"></i> ${topic.author}</span>
                <span><i class="fas fa-clock"></i> ${topic.time}</span>
                <span><i class="fas fa-comment"></i> ${topic.messages || 0} ответов</span>
            </div>
        `;
        
        item.addEventListener('click', () => openTopic(topic.id));
        container.appendChild(item);
    });
}

function renderMessages(topicId) {
    const topic = forumData.topics.find(t => t.id === topicId);
    const messages = forumData.messages.filter(m => m.topicId === topicId);
    const container = document.getElementById('messagesList');
    const title = document.getElementById('currentTopicTitle');
    
    title.textContent = topic.title;
    container.innerHTML = '';
    
    // Сама тема как первое сообщение
    const topicMessage = document.createElement('div');
    topicMessage.className = 'message';
    topicMessage.innerHTML = `
        <div class="message-author">${topic.author}</div>
        <div class="message-text">${topic.text}</div>
        <div class="message-time">${topic.time} (тема)</div>
    `;
    container.appendChild(topicMessage);
    
    // Ответы
    messages.forEach(msg => {
        const msgEl = document.createElement('div');
        msgEl.className = 'message';
        msgEl.innerHTML = `
            <div class="message-author">${msg.author}</div>
            <div class="message-text">${msg.text}</div>
            <div class="message-time">${msg.time}</div>
        `;
        container.appendChild(msgEl);
    });
    
    // Прокрутка вниз
    container.scrollTop = container.scrollHeight;
}

// ========== НАВИГАЦИЯ ==========
function openCategory(categoryId) {
    currentCategory = categoryId;
    currentView = 'topics';
    currentTopic = null;
    
    document.getElementById('categoriesSection').classList.add('hidden');
    document.getElementById('topicsSection').classList.remove('hidden');
    document.getElementById('messagesSection').classList.add('hidden');
    document.getElementById('newTopicForm').classList.add('hidden');
    document.getElementById('btnBack').classList.remove('hidden');
    
    renderTopics(categoryId);
}

function openTopic(topicId) {
    currentTopic = topicId;
    currentView = 'messages';
    
    document.getElementById('topicsSection').classList.add('hidden');
    document.getElementById('messagesSection').classList.remove('hidden');
    document.getElementById('newMessageForm').classList.add('hidden');
    
    renderMessages(topicId);
}

function goBack() {
    if (currentView === 'messages') {
        // Возврат из темы в список тем
        currentView = 'topics';
        currentTopic = null;
        
        document.getElementById('messagesSection').classList.add('hidden');
        document.getElementById('topicsSection').classList.remove('hidden');
        renderTopics(currentCategory);
    } else if (currentView === 'topics') {
        // Возврат в категории
        currentView = 'categories';
        currentCategory = null;
        
        document.getElementById('topicsSection').classList.add('hidden');
        document.getElementById('categoriesSection').classList.remove('hidden');
        document.getElementById('btnBack').classList.add('hidden');
    }
    
    // Скрываем все формы
    document.getElementById('newTopicForm').classList.add('hidden');
    document.getElementById('newMessageForm').classList.add('hidden');
}

// ========== СОЗДАНИЕ НОВЫХ ДАННЫХ ==========
function showNewTopicForm() {
    document.getElementById('newTopicForm').classList.remove('hidden');
    if (currentCategory) {
        document.getElementById('topicCategory').value = currentCategory;
    }
}

function submitNewTopic() {
    const title = document.getElementById('topicTitle').value.trim();
    const text = document.getElementById('topicText').value.trim();
    const category = document.getElementById('topicCategory').value;
    
    if (!title || !text) {
        alert('Заполните заголовок и текст темы');
        return;
    }
    
    const newTopic = {
        id: 'topic_' + Date.now(),
        category: category,
        title: title,
        author: 'Вы',
        text: text,
        time: new Date().toLocaleString(),
        messages: 0
    };
    
    forumData.topics.push(newTopic);
    saveData();
    
    // Очистка формы
    document.getElementById('topicTitle').value = '';
    document.getElementById('topicText').value = '';
    document.getElementById('newTopicForm').classList.add('hidden');
    
    // Обновление интерфейса
    if (currentCategory === category) {
        renderTopics(category);
    }
    
    alert('Тема создана!');
}

function showNewMessageForm() {
    document.getElementById('newMessageForm').classList.remove('hidden');
    document.getElementById('messageText').focus();
}

function submitNewMessage() {
    const text = document.getElementById('messageText').value.trim();
    
    if (!text) {
        alert('Введите текст сообщения');
        return;
    }
    
    const newMessage = {
        id: 'msg_' + Date.now(),
        topicId: currentTopic,
        author: 'Вы',
        text: text,
        time: new Date().toLocaleString()
    };
    
    // Добавляем сообщение
    forumData.messages.push(newMessage);
    
    // Увеличиваем счётчик сообщений в теме
    const topic = forumData.topics.find(t => t.id === currentTopic);
    if (topic) {
        topic.messages = (topic.messages || 0) + 1;
    }
    
    saveData();
    
    // Очистка и скрытие
    document.getElementById('messageText').value = '';
    document.getElementById('newMessageForm').classList.add('hidden');
    
    // Обновляем список сообщений
    renderMessages(currentTopic);
}

// ========== ПОИСК ==========
function performSearch() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    
    if (!query) {
        if (currentView === 'categories') renderCategories();
        else if (currentView === 'topics' && currentCategory) renderTopics(currentCategory);
        else if (currentView === 'messages' && currentTopic) renderMessages(currentTopic);
        return;
    }
    
    if (currentView === 'categories') {
        // Фильтрация категорий
        const filtered = forumData.categories.filter(cat => 
            cat.title.toLowerCase().includes(query) || 
            cat.desc.toLowerCase().includes(query)
        );
        
        const container = document.getElementById('categoriesList');
        container.innerHTML = '';
        
        filtered.forEach(cat => {
            const card = document.createElement('div');
            card.className = 'category-card';
            card.innerHTML = `
                <h3 class="category-title">${cat.title}</h3>
                <p class="category-desc">${cat.desc}</p>
            `;
            card.addEventListener('click', () => openCategory(cat.id));
            container.appendChild(card);
        });
    }
    
    if (currentView === 'topics' && currentCategory) {
        // Фильтрация тем
        const topics = forumData.topics.filter(t => 
            t.category === currentCategory &&
            (t.title.toLowerCase().includes(query) || t.text.toLowerCase().includes(query))
        );
        
        const container = document.getElementById('topicsList');
        container.innerHTML = '';
        
        topics.forEach(topic => {
            const item = document.createElement('div');
            item.className = 'topic-item';
            item.innerHTML = `
                <h4 class="topic-title">${topic.title}</h4>
                <p>${topic.text.substring(0, 100)}...</p>
            `;
            item.addEventListener('click', () => openTopic(topic.id));
            container.appendChild(item);
        });
    }
}

// ========== НАСТРОЙКА СОБЫТИЙ ==========
function setupEventListeners() {
    // Кнопки навигации
    document.getElementById('btnBack').addEventListener('click', goBack);
    
    // Кнопки создания
    document.getElementById('btnNewTopic').addEventListener('click', showNewTopicForm);
    document.getElementById('btnNewTopicInCategory').addEventListener('click', showNewTopicForm);
    document.getElementById('btnNewMessage').addEventListener('click', showNewMessageForm);
    
    // Формы
    document.getElementById('btnCancelTopic').addEventListener('click', () => {
        document.getElementById('newTopicForm').classList.add('hidden');
    });
    
    document.getElementById('btnSubmitTopic').addEventListener('click', submitNewTopic);
    
    document.getElementById('btnCancelMessage').addEventListener('click', () => {
        document.getElementById('newMessageForm').classList.add('hidden');
    });
    
    document.getElementById('btnSubmitMessage').addEventListener('click', submitNewMessage);
    
    // Поиск
    document.getElementById('searchInput').addEventListener('input', performSearch);
    
    // Enter для форм
    document.getElementById('topicTitle').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('btnSubmitTopic').click();
    });
    
    document.getElementById('messageText').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            document.getElementById('btnSubmitMessage').click();
        }
    });
}
